<html>
	<head>
		<script src="js/lib/jquery-1.11.1.min.js"></script>
        <script src="js/lib/chartjs/Chart.min.js"></script>

        <script src="js/src/Synapse.js"></script>
        <script src="js/src/Neuron.js"></script>
        <script src="js/src/Layer.js"></script>
        <script src="js/src/NeuralNetwork.js"></script>

		<script>
            var neuralNetwork;
            var radarChart;

			var PIXEL_SIZE = 30; //pixels

			var GRID_WIDTH = 0;
			var GRID_HEIGHT = 0; 

            var HIDDEN_LAYER_PROPERTIES = [6];
			var OUTPUT_COUNT = 10;

            var LEARNING_RATE = 0.30;
            var VALIDATION_THRESHOLD = 0.50;

			var pixels = [];

			var mousePressed = false;
			var mousePixelIndex = -1;
			function init() {
				var canvas = document.getElementById("canvas");
				GRID_WIDTH = Math.floor(canvas.width/PIXEL_SIZE);
				GRID_HEIGHT = Math.floor(canvas.height/PIXEL_SIZE);

                initializeRadarChart();

                neuralNetwork = new NeuralNetwork(GRID_WIDTH * GRID_HEIGHT, HIDDEN_LAYER_PROPERTIES, OUTPUT_COUNT, LEARNING_RATE);

				resetCanvas();

				canvas.addEventListener("click", function(e) {
					var mousePoint = mouseCanvasPosition(e);
					togglePixelAtPoint(mousePoint);
					drawPixels();	
				});

				canvas.addEventListener("mousedown", function(e) {
					mousePressed = true;
				}, false);
				canvas.addEventListener("mouseup", function(e) {
					mousePressed = false;
				}, false);		

				canvas.addEventListener("mousemove", function(e) {
					if(mousePressed) {
						var mousePoint = mouseCanvasPosition(e);
						var pixelIndex = pixelIndexAtPoint(e);
						if(pixelIndex != mousePixelIndex) {
							setPixelValueAtPoint(mousePoint, true);
							drawPixels();	
							mousePixelIndex = pixelIndex;												
						}
					}
				})
			}

            function initializeRadarChart() {
                var radarChartContext = document.getElementById("radarChart").getContext("2d");

                var data = {
                    labels: [],
                    datasets: [
                        {
                            label: "Neural Network Output",
                            fillColor: "rgba(151,187,205,0.2)",
                            strokeColor: "rgba(151,187,205,1)",
                            pointColor: "rgba(151,187,205,1)",
                            pointStrokeColor: "#fff",
                            pointHighlightFill: "#fff",
                            pointHighlightStroke: "rgba(151,187,205,1)",
                            data: []
                        }
                    ]
                };

                for (var outputIndex = 0; outputIndex < OUTPUT_COUNT; outputIndex++) {
                    data.labels.push("Chiffre " + outputIndex);
                    data.datasets[0].data.push(0);
                }

                radarChart = new Chart(radarChartContext).Radar(data);
            }

			function learnClicked() {
				var learnedNumber = parseInt($("#inputNumber").val());
				learn(learnedNumber);
				processClicked();
			}

			function processClicked() {
                process();

                // Process the output layer neurons' values
                var outputValues = [];
                for (var neuronIndex = 0; neuronIndex < neuralNetwork.outputLayer.neurons.length; neuronIndex++) {
                    var outputNeuron = neuralNetwork.outputLayer.neurons[neuronIndex];

                    // Output the neuron's value
                    radarChart.datasets[0].points[neuronIndex].value = outputNeuron.output;

                    // Apply the validation threshold
                    if (outputNeuron.output >= VALIDATION_THRESHOLD) {
                        outputValues.push(neuronIndex);
                    }
                }

                // Refresh the Radar Chart
                radarChart.update();

				showProcessedNumbers(outputValues);
			}

			function showProcessedNumbers(processedNumbers) {
				var result = "";
				for(var i = 0; i < processedNumbers.length; i++) {
					result += processedNumbers[i].toString() + ",";
				}
				if(result.length > 0) result = result.substring(0, result.length-1);
				$("#outputNumber").val(result);
			}

/* ------  */

			function learn(number) {
                //for (var iteration = 0; iteration < 1500 && neuralNetwork.outputLayer.neurons[number].output < VALIDATION_THRESHOLD; iteration++) {
                    neuralNetwork.forwardPropagate();

                    neuralNetwork.learn(number);
                //}
			}

			function process() {
                var linearPixelData = convertPixelsToLinearTable();

                // Set the input layer output to the pixel values
                for (var pixelIndex = 0; pixelIndex < linearPixelData.length; pixelIndex++) {
                    neuralNetwork.inputLayer.neurons[pixelIndex].output = linearPixelData[pixelIndex] ? 1 : 0;
                }

                // Forward propagate in the neural network
                neuralNetwork.forwardPropagate();
			}

            function convertPixelsToLinearTable() {
                var linearPixels = [];
                for (var y = 0; y < pixels.length; y++) {
                    for (var x = 0; x < pixels[y].length; x++) {
                        linearPixels[y * pixels[y].length + x] = pixels[y][x];
                    }
                }

                return linearPixels;
            }


/* ------  */


			function mouseCanvasPosition(e) {
        		var rect = canvas.getBoundingClientRect();
        		return {
          			x: e.clientX - rect.left,
          			y: e.clientY - rect.top
        		};
      		}

      		function pixelIndexAtPoint(point) {
				var pixelIndex = -1;
      			var x = Math.floor(point.x/PIXEL_SIZE);
      			var y = Math.floor(point.y/PIXEL_SIZE);
      			if(x < GRID_WIDTH && y < GRID_HEIGHT) {
      				pixelIndex = y * GRID_WIDTH + x;
      			}
      			return pixelIndex;
      		}

      		function togglePixelAtPoint(point) {
      			var x = Math.floor(point.x/PIXEL_SIZE);
      			var y = Math.floor(point.y/PIXEL_SIZE);
      			if(x < GRID_WIDTH && y < GRID_HEIGHT) {
      				pixels[x][y] = !pixels[x][y];
      			}
      		}

      		function setPixelValueAtPoint(point, value) {
      			var x = Math.floor(point.x/PIXEL_SIZE);
      			var y = Math.floor(point.y/PIXEL_SIZE);
      			if(x < GRID_WIDTH && y < GRID_HEIGHT) {
      				pixels[x][y] = value;      				
      			}
      		}

      		function resetCanvas() {
      			resetPixels();
      			drawPixels();
      		}

      		function resetPixels() {      				
			for(var x = 0; x < GRID_WIDTH; x++) {
				pixels[x] = [];
      			for(var y = 0; y < GRID_HEIGHT; y++) {						
						pixels[x][y] = false;
					}
				}
      		}

			function drawPixels() {
				var canvas = document.getElementById("canvas");
				var context = canvas.getContext("2d");

				for(var y = 0; y < GRID_HEIGHT; y++) {
					for(var x = 0; x < GRID_WIDTH; x++) {
						context.beginPath();
						context.rect(x*PIXEL_SIZE, y*PIXEL_SIZE, PIXEL_SIZE, PIXEL_SIZE);
						context.fillStyle = pixels[x][y] ? '#2D2' : '#555';
						context.fill();
						context.lineWidth = 1;
						context.strokeStyle = '#000';
						context.stroke();						
					}
				}
			}

		</script>
	</head>
	<body onLoad="init();">
	<canvas id="canvas" width="300" height="400" style="float:left">
		alternate content
	</canvas>
	<div style="margin-left:50px;float:left">
		<input type="button" value="Reset canvas" onclick="resetCanvas()"/><br/>
		<br/>
		<input type="text" id="inputNumber"><input type="button" value="Learn" onclick="learnClicked()"/><br/>
		<input type="text" id="outputNumber"><input type="button" value="Process" onclick="processClicked()"/><br/>
        <br/>
        <canvas id="radarChart" width="400" height="400"></canvas>
	</div>
</body>
</html>